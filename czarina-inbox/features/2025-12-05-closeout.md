# Feature: Project Closeout Command

**Date:** 2025-12-05
**Status:** âœ… Implemented
**Type:** Enhancement
**Component:** closeout-project.sh

## Overview

Added comprehensive closeout command to cleanly shut down orchestrations, archive logs, clean up resources, and generate completion reports.

## Problem

Before closeout command:
- Manual tmux session killing
- Orphaned worktrees consuming disk space
- Lost logs and session history
- No audit trail of orchestration completion
- Resource leaks from abandoned sessions
- Unclear project state after completion

## Solution

Automated, interactive closeout process with safety checks and audit trail.

## Features

### 1. Session Management
```bash
# Finds and stops all project sessions
- czarina-memory-1
- czarina-memory-2
- project-slug-daemon
```

Auto-discovers sessions by:
- Project slug matching
- Czarina naming patterns
- Daemon session detection

### 2. Log Archiving
```
.czarina/archive/
â””â”€â”€ 2025-12-05_14-30-45/      # Timestamped
    â”œâ”€â”€ status/                # All daemon logs
    â”‚   â””â”€â”€ daemon.log
    â””â”€â”€ CLOSEOUT_REPORT.md     # Completion summary
```

Preserves:
- Daemon activity logs
- Worker status files
- Timestamped snapshots

### 3. Worktree Cleanup
Interactive removal:
```bash
Found 11 worktree(s)
Remove all worktrees? (y/N): y
```

Process:
1. Removes each worktree directory
2. Runs `git worktree prune`
3. Cleans up worktrees directory
4. Recovers disk space

### 4. Closeout Report
Generated markdown report includes:

**Summary Section:**
- Project name and slug
- Completion timestamp
- Repository location

**Activity Section:**
- Sessions stopped (count)
- Daemon status
- Archive location
- Worktree cleanup decision

**Git Section:**
- Current git status
- Uncommitted changes
- Branch state

**Workers Section:**
- Complete worker list
- Assigned tasks
- Descriptions

**Next Steps:**
- Review archived logs
- Merge remaining PRs
- Clean up branches
- Restart instructions

### 5. Safety Features

**Confirmation Prompts:**
```bash
Are you sure you want to close out? (y/N)
Remove all worktrees? (y/N)
```

**Non-Destructive:**
- Archives before cleanup
- Asks before removing worktrees
- Preserves git repository
- Keeps worker configuration

## Usage

```bash
# From project directory
cd ~/my-project
czarina closeout

# From anywhere with project name
czarina closeout my-project
```

### Interactive Flow
```
ðŸŽ­ Czarina Project Closeout
   Project: My Project
   ...
Are you sure? (y/N): y

1. Stopping tmux sessions...
   âœ… Stopped 3 session(s)

2. Stopping daemon...
   âœ… Daemon stopped

3. Archiving logs...
   âœ… Logs archived to: .czarina/archive/...

4. Git worktrees cleanup...
   Found 11 worktree(s)
   Remove all worktrees? (y/N): y
   âœ… All worktrees removed

5. Generating final status report...
   âœ… Report saved: .../CLOSEOUT_REPORT.md

âœ… Closeout complete!
```

## Implementation

### Process Flow
```
closeout-project.sh
â”œâ”€â”€ Load config.json
â”œâ”€â”€ Confirm closeout
â”œâ”€â”€ Kill tmux sessions
â”œâ”€â”€ Stop daemon
â”œâ”€â”€ Archive logs (timestamp)
â”œâ”€â”€ Optional: Remove worktrees
â”‚   â”œâ”€â”€ git worktree remove (each)
â”‚   â””â”€â”€ git worktree prune
â””â”€â”€ Generate CLOSEOUT_REPORT.md
```

### Resource Recovery

**Tmux Sessions:**
- Frees terminal multiplexer resources
- Closes SSH connections
- Releases PTY allocations

**Git Worktrees:**
- Recovers disk space (11 worktrees Ã— repo size)
- Cleans git metadata
- Removes lock files

**Daemon:**
- Stops auto-approval process
- Frees CPU cycles
- Releases file handles

## Value

âœ… **Clean Shutdown**: No orphaned processes
âœ… **Audit Trail**: Complete closeout record
âœ… **Resource Recovery**: Disk space and processes
âœ… **Easy Restart**: Clear state for relaunch
âœ… **Safe**: Confirmation prompts, archives first

## Example Report

```markdown
# Czarina Closeout Report - My Project

**Date:** 2025-12-05 14:30:45
**Project:** My Project
**Location:** /home/user/project

## Summary
This orchestration has been closed out...

## Sessions Stopped
- Worker sessions: 2
- Daemon: Stopped

## Archives
- Location: .czarina/archive/2025-12-05_14-30-45/
- Logs: Archived

## Worktrees
- Initial count: 11
- Status: Removed

## Next Steps
1. Review archived logs
2. Merge remaining PRs
3. Clean up branches
...
```

## Testing

Verified with:
- 11-worker orchestration
- Multiple tmux sessions
- Large log directories
- Git worktrees present/absent
- Daemon running/stopped

## Future Enhancements

- [ ] Export worker artifacts (PRs, branches)
- [ ] Generate metrics summary
- [ ] Email/notify on completion
- [ ] Slack/Discord integration
- [ ] Archive to cloud storage
- [ ] Generate cost report (tokens used)

## Metrics

- **Disk Recovery**: ~11Ã— repo size (with worktrees)
- **Process Cleanup**: 3+ tmux sessions
- **Archive Size**: Varies by logs
- **Execution Time**: <5 seconds (interactive)
