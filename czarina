#!/usr/bin/env python3
"""
Czarina - Multi-Agent Orchestration CLI
Simple interface for managing multi-agent orchestration projects

Usage:
    czarina list                    - List available projects
    czarina init <project>          - Initialize git branches for project
    czarina dashboard <project>     - Launch project dashboard
    czarina launch <project>        - Launch project workers
    czarina status <project>        - Show project status
"""

import sys
import subprocess
from pathlib import Path


def get_orchestrator_dir():
    """Get the orchestrator root directory"""
    return Path(__file__).parent.resolve()


def get_project_dir(project_name):
    """Get project directory"""
    orchestrator_dir = get_orchestrator_dir()
    project_dir = orchestrator_dir / "projects" / f"{project_name}-orchestration"

    if not project_dir.exists():
        print(f"‚ùå Project '{project_name}' not found")
        print(f"   Expected: {project_dir}")
        sys.exit(1)

    return project_dir


def get_config_file(project_name):
    """Get project config.sh file"""
    project_dir = get_project_dir(project_name)
    config_file = project_dir / "config.sh"

    if not config_file.exists():
        print(f"‚ùå Config file not found: {config_file}")
        sys.exit(1)

    return config_file


def cmd_dashboard(project_name):
    """Launch dashboard for project"""
    orchestrator_dir = get_orchestrator_dir()
    config_file = get_config_file(project_name)
    dashboard_script = orchestrator_dir / "czarina-core" / "dashboard.py"

    print(f"üéØ Czarina Dashboard - {project_name}")
    print(f"   Config: {config_file}")
    print(f"   Press Ctrl+C to exit")
    print()

    try:
        subprocess.run(
            ["python3", str(dashboard_script), str(config_file)],
            cwd=str(orchestrator_dir)
        )
    except KeyboardInterrupt:
        print("\n‚úÖ Dashboard stopped")


def cmd_launch(project_name):
    """Launch workers for project"""
    project_dir = get_project_dir(project_name)

    # Look for launch scripts
    launch_scripts = list(project_dir.glob("launch*.sh"))

    if not launch_scripts:
        print(f"‚ùå No launch scripts found in {project_dir}")
        sys.exit(1)

    if len(launch_scripts) == 1:
        launch_script = launch_scripts[0]
    else:
        print("üìã Available launch scripts:")
        for i, script in enumerate(launch_scripts, 1):
            print(f"   {i}. {script.name}")

        choice = input("\nSelect script (1-{}): ".format(len(launch_scripts)))
        try:
            launch_script = launch_scripts[int(choice) - 1]
        except (ValueError, IndexError):
            print("‚ùå Invalid selection")
            sys.exit(1)

    print(f"üöÄ Launching workers with {launch_script.name}...")
    subprocess.run(["bash", str(launch_script)], cwd=str(project_dir))


def cmd_status(project_name):
    """Show project status"""
    project_dir = get_project_dir(project_name)
    config_file = get_config_file(project_name)

    # Source config and show worker info
    result = subprocess.run(
        ["bash", "-c", f"source {config_file} && printf '%s\\n' \"${{WORKER_DEFINITIONS[@]}}\""],
        capture_output=True,
        text=True
    )

    print(f"üìä Project: {project_name}")
    print(f"   Location: {project_dir}")
    print()
    print("Workers:")

    for line in result.stdout.strip().split('\n'):
        if line:
            parts = line.split('|')
            if len(parts) >= 4:
                worker_id, branch, task_file, description = parts[0], parts[1], parts[2], parts[3]
                print(f"  ‚Ä¢ {worker_id:12} ‚Üí {branch:30} ({description})")


def cmd_init(project_name):
    """Initialize git branches for project workers"""
    orchestrator_dir = get_orchestrator_dir()
    config_file = get_config_file(project_name)
    init_script = orchestrator_dir / "czarina-core" / "init-branches.sh"

    if not init_script.exists():
        print(f"‚ùå Init script not found: {init_script}")
        sys.exit(1)

    print(f"üåø Initializing git branches for: {project_name}")
    print(f"   Config: {config_file}")
    print()

    subprocess.run(["bash", str(init_script), str(config_file)])


def cmd_list():
    """List available projects"""
    orchestrator_dir = get_orchestrator_dir()
    projects_dir = orchestrator_dir / "projects"

    print("üìã Available projects:")

    for project_dir in sorted(projects_dir.iterdir()):
        if project_dir.is_dir() and project_dir.name.endswith("-orchestration"):
            project_name = project_dir.name.replace("-orchestration", "")
            config_file = project_dir / "config.sh"

            if config_file.exists():
                # Read project name from config
                result = subprocess.run(
                    ["bash", "-c", f"source {config_file} && echo $PROJECT_NAME"],
                    capture_output=True,
                    text=True
                )
                full_name = result.stdout.strip()
                print(f"  ‚Ä¢ {project_name:20} - {full_name}")
            else:
                print(f"  ‚Ä¢ {project_name:20} - (no config)")


def show_usage():
    """Show usage information"""
    print(__doc__)
    print("\nExamples:")
    print("  czarina list")
    print("  czarina init sark-v2")
    print("  czarina dashboard sark-v2")
    print("  czarina launch sark-v2")
    print("  czarina status sark-v2")


def main():
    if len(sys.argv) < 2:
        show_usage()
        sys.exit(1)

    command = sys.argv[1]

    if command == "list":
        cmd_list()
    elif command == "init":
        if len(sys.argv) < 3:
            print("‚ùå Usage: czarina init <project>")
            sys.exit(1)
        cmd_init(sys.argv[2])
    elif command == "dashboard":
        if len(sys.argv) < 3:
            print("‚ùå Usage: czarina dashboard <project>")
            sys.exit(1)
        cmd_dashboard(sys.argv[2])
    elif command == "launch":
        if len(sys.argv) < 3:
            print("‚ùå Usage: czarina launch <project>")
            sys.exit(1)
        cmd_launch(sys.argv[2])
    elif command == "status":
        if len(sys.argv) < 3:
            print("‚ùå Usage: czarina status <project>")
            sys.exit(1)
        cmd_status(sys.argv[2])
    elif command in ["-h", "--help", "help"]:
        show_usage()
    else:
        print(f"‚ùå Unknown command: {command}")
        show_usage()
        sys.exit(1)


if __name__ == "__main__":
    main()
